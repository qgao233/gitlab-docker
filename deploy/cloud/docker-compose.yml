version: '3.8'

# ============================================================
# GitLab 云部署配置（GitLab 15.11.13）
# ============================================================
# 外部 PostgreSQL + 内置 Redis
#
# 【配置方式】
#   1. 复制 .env.example 为 .env
#   2. 修改 GITLAB_HOST 和数据库配置
#   3. 运行 ./start.sh
#
# 【端口说明】
#   80  - HTTP Web 访问
#   22  - SSH 推拉仓库
#   443 - HTTPS Web 访问（需配置域名和证书）
# ============================================================

services:
  gitlab:
    image: 'docker.1ms.run/gitlab/gitlab-ce:15.11.13-ce.0'
    container_name: gitlab
    restart: always
    hostname: '${GITLAB_HOST:-localhost}'
    environment:
      GITLAB_HOST: '${GITLAB_HOST:-localhost}'
      DB_HOST: '${DB_HOST:-}'
      DB_PORT: '${DB_PORT:-5432}'
      DB_NAME: '${DB_NAME:-gitlabhq_production}'
      DB_USER: '${DB_USER:-gitlab}'
      DB_PASSWORD: '${DB_PASSWORD:-}'
      GITLAB_OMNIBUS_CONFIG: |
        # ============ 访问地址配置 ============
        # 使用域名或公网 IP
        external_url "http://#{ENV['GITLAB_HOST']}"
        
        # SSH 端口（22 端口用于服务器管理，GitLab 用 9922）
        gitlab_rails['gitlab_shell_ssh_port'] = 9922
        
        # 时区设置
        gitlab_rails['time_zone'] = 'Asia/Shanghai'
        
        # ============ 外部 PostgreSQL 配置 ============
        postgresql['enable'] = false
        gitlab_rails['db_adapter'] = 'postgresql'
        gitlab_rails['db_encoding'] = 'unicode'
        gitlab_rails['db_host'] = ENV['DB_HOST']
        gitlab_rails['db_port'] = ENV['DB_PORT'].to_i
        gitlab_rails['db_database'] = ENV['DB_NAME']
        gitlab_rails['db_username'] = ENV['DB_USER']
        gitlab_rails['db_password'] = ENV['DB_PASSWORD']
        
        # ============ 内置 Redis ============
        # 阿里云 Redis < 6.0 不兼容，使用内置 Redis
        
        # ============ 性能优化 ============
        puma['worker_processes'] = 2
        puma['min_threads'] = 1
        puma['max_threads'] = 4
        sidekiq['concurrency'] = 10
        
        # ============ 禁用监控组件（节省内存） ============
        prometheus_monitoring['enable'] = false
        alertmanager['enable'] = false
        node_exporter['enable'] = false
        redis_exporter['enable'] = false
        postgres_exporter['enable'] = false
        gitlab_exporter['enable'] = false
        grafana['enable'] = false
        
        # ============ HTTPS 配置（可选） ============
        # 【方式一】使用自己的 SSL 证书
        # 1. 将证书文件放到 ./ssl/ 目录：
        #    - ssl/gitlab.example.com.pem（证书，支持 .crt/.pem）
        #    - ssl/gitlab.example.com.key（私钥）
        # 2. 取消以下注释：
        external_url "https://#{ENV['GITLAB_HOST']}"
        nginx['ssl_certificate'] = "/etc/gitlab/ssl/#{ENV['GITLAB_HOST']}.pem"
        nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/#{ENV['GITLAB_HOST']}.key"
        
        # 【方式二】使用 Let's Encrypt 自动获取证书
        # external_url "https://#{ENV['GITLAB_HOST']}"
        # letsencrypt['enable'] = true
        # letsencrypt['contact_emails'] = ['admin@example.com']
        
    ports:
      # - '80:80'   # HTTP 已禁用，仅使用 HTTPS
      - '9922:22'   # SSH 用 9922，避免与服务器管理端口冲突
      - '443:443'
    
    volumes:
      - './gitlab/config:/etc/gitlab'
      - './gitlab/logs:/var/log/gitlab'
      - './gitlab/data:/var/opt/gitlab'
      - './ssl:/etc/gitlab/ssl:ro'  # SSL 证书目录（只读）
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    
    shm_size: '256m'

networks:
  gitlab_network:
    driver: bridge
